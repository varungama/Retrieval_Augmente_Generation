<!DOCTYPE html>
<link rel="stylesheet" href="style.css">
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG</title>
    <script>
        async function uploadFiles() {
            const input = document.getElementById('files');
            const formData = new FormData();
            // Append each file to the form data
            for (let i = 0; i < input.files.length; i++) {
                formData.append("files", input.files[i]);
            }
            // Send the files to the backend
            const response = await fetch('/upload-files/', {
                method: 'POST',
                body: formData
            });
            if (response.ok) {
                const result = await response.json();
                alert(`Files uploaded successfully: ${result.files}`);
            } else {
                const errorMessage = await response.text();
                alert(`Error: ${errorMessage}`);
            }
        }
        async function runBackendFunction() {
            // Send a POST request to the backend endpoint
            const response = await fetch('/run-function/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
             if (response.ok) {
                const result = await response.json();
                // Display the result
                alert(`Success: ${result.message}`);
            } else {
                const errorMessage = await response.text();
                alert(`Error: ${errorMessage}`);
            }
        }
        async function askQuestion() {
            const question = document.getElementById('question').value;
            const chatbox = document.getElementById('chatbox');
            if (!question) {
                alert("Please enter a question");
                return;
            }
            const response = await fetch('/ask/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ question })  // Send the question as JSON in the body
            });
            if (response.ok) {
                const result = await response.json();
                chatbox.innerHTML += `<p><strong>You:</strong> ${question}</p>`;
                chatbox.innerHTML += `<p><strong>Bot:</strong> ${result.response}</p>`;
            } else {
                const errorMessage = await response.text();
                alert(`Error: ${errorMessage}`);
                }
            }

        async function loadPlot() {
            // Fetch the image from the backend
            const response = await fetch('/plot');
            const blob = await response.blob();

            // Create an object URL for the image
            const imgUrl = URL.createObjectURL(blob);

            // Set the source of the image element
            document.getElementById('plot-image').src = imgUrl;
        }

    </script>
</head>
<body onload="loadPlot()">
    <h1>Retrieval-Augmented Generation (RAG) For Provided the Survey Datasets</h1>
    <h3>Model is ready to query on Sustainability Research & Christmas Research Data</h3>
    <h3>If you want to work with another new data please upload the file and click preprocess and then make queries</h3>
    <!-- CSV & Excel File Upload -->
    <input type="file" id="files" accept=".csv, .xlsx" multiple><br><br>
    <button onclick="uploadFiles()">Upload Files</button>

<!--    <input><br><br>-->
    <button onclick="runBackendFunction()">Preprocess Data</button>

    <!-- Chatbox for QA -->
    <div id="chatbox"></div>

    <!-- Question Input -->
    <input type="text" id="question" placeholder="Ask a question..."><br>
    <button onclick="askQuestion()">Ask</button>


    <div class="container">
        <h1>Dynamic Plot Display</h1>
        <h3>Graphs generated from Default </h3>

        <!-- Container for the Plot Image -->
        <div class="plot-container">
            <img id="plot-image" alt="Plot will be displayed here" />
        </div>
    </div>

</body>
</html>